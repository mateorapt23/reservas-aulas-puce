{% extends "base.html" %}
{% block title %}Aulas{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">

    <!-- T√çTULO -->
    <div class="mb-8">
        <h1 class="text-2xl font-semibold text-white">Aulas</h1>
        <p class="text-sm text-gray-400">
            Gestiona aulas, capacidad y requerimientos
        </p>
    </div>

    <!-- BARRA SUPERIOR -->
    <div class="flex flex-col sm:flex-row gap-4 items-center justify-between mb-6">

        {% csrf_token %}

        <!-- BUSCADOR -->
        <input type="text"
               id="buscador"
               value="{{ q }}"
               placeholder="üîç Buscar aula..."
               class="input input-bordered w-full sm:max-w-sm
                      bg-[#0f172a] border-white/10 text-white"/>

        <div class="flex items-center gap-3">

            <!-- AGREGAR -->
            <div id="agregar-wrapper" class="flex items-center gap-2">
                <button id="btn-agregar"
                        class="btn btn-sm btn-primary">
                    ‚ûï Agregar
                </button>
            </div>

            <!-- ORDEN -->
            <select id="orden"
                    class="select select-bordered
                           bg-[#0f172a] border-white/10 text-white">
                <option value="asc" {% if order == 'asc' %}selected{% endif %}>
                    ASC
                </option>
                <option value="desc" {% if order == 'desc' %}selected{% endif %}>
                    DES
                </option>
            </select>
        </div>
    </div>

    <!-- LISTA DE AULAS -->
    <div id="lista-aulas"
         class="bg-[#020617] rounded-2xl border border-white/10 divide-y divide-white/5">

        {% for aula in aulas %}
        <div class="flex flex-col gap-2 p-4 hover:bg-white/5 transition">

            <!-- FILA PRINCIPAL -->
            <div class="flex items-center justify-between"
                 data-id="{{ aula.id }}"
                 data-numero="{{ aula.numero }}"
                 data-capacidad="{{ aula.capacidad }}">

                <!-- CONTENIDO EDITABLE -->
                <div class="contenido-aula text-white text-sm flex items-center gap-2 flex-wrap">

                    <span class="font-semibold">
                        Aula {{ aula.numero }}
                    </span>

                    <span class="text-gray-400">
                        ¬∑ Capacidad: {{ aula.capacidad }}
                    </span>

                </div>

                <!-- BOTONES -->
                <div class="flex gap-2">
                    <button class="btn-editar btn btn-xs btn-outline"
                            data-id="{{ aula.id }}">
                        ‚úèÔ∏è
                    </button>

                    <button class="btn-eliminar btn btn-xs btn-error btn-outline"
                            data-id="{{ aula.id }}">
                        üóëÔ∏è
                    </button>
                </div>
            </div>

            <!-- REQUERIMIENTOS -->
            <div class="flex flex-wrap gap-2 text-xs text-gray-300">
                {% for r in aula.requerimientos.all %}
                    <span class="px-2 py-1 rounded bg-white/10">
                        {{ r.nombre }}
                    </span>
                {% empty %}
                    <span class="text-gray-500 italic">
                        Sin requerimientos
                    </span>
                {% endfor %}
            </div>

        </div>
        {% empty %}
        <div class="p-6 text-center text-gray-400 text-sm">
            No hay aulas registradas
        </div>
        {% endfor %}

    </div>
</div>

<!-- =========================
     REQUERIMIENTOS GLOBALES
========================= -->
<script>
const requerimientosGlobales = [
    {% for r in requerimientos %}
        { id: {{ r.id }}, nombre: "{{ r.nombre }}" },
    {% endfor %}
];
</script>

<!-- =========================
     SCRIPT PRINCIPAL
========================= -->
<script>
const buscador = document.getElementById("buscador");
const orden = document.getElementById("orden");
const lista = document.getElementById("lista-aulas");
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

let timeout = null;

/* =========================
   CARGAR LISTA
========================= */
function cargarAulas() {
    fetch(`?q=${encodeURIComponent(buscador.value)}&order=${orden.value}`)
        .then(r => r.text())
        .then(html => {
            const doc = new DOMParser().parseFromString(html, "text/html");
            lista.innerHTML = doc.getElementById("lista-aulas").innerHTML;
            activarEventos();
        });
}

buscador.addEventListener("input", () => {
    clearTimeout(timeout);
    timeout = setTimeout(cargarAulas, 300);
});

orden.addEventListener("change", cargarAulas);

/* =========================
   AGREGAR
========================= */
document.getElementById("btn-agregar").onclick = () => {
    const wrapper = document.getElementById("agregar-wrapper");

    wrapper.innerHTML = `
        <div class="flex flex-col gap-3 w-full max-w-md">
            <div class="flex gap-2">
                <input id="nuevo-numero" placeholder="Aula"
                       class="input input-sm bg-[#0f172a] border-white/10 text-white w-20">

                <input id="nueva-capacidad" type="number" placeholder="Capacidad"
                       class="input input-sm bg-[#0f172a] border-white/10 text-white w-28">
            </div>

            <div>
                <input type="text"
                       id="buscador-req-nuevo"
                       placeholder="Buscar requerimiento..."
                       class="input input-bordered input-sm w-full bg-[#0f172a] border-white/10 text-white mb-2" />

                <div id="lista-req-nuevo"
                     class="max-h-40 overflow-y-auto space-y-2 p-3 rounded-xl bg-[#0f172a] border border-white/10">
                    ${requerimientosGlobales.map(r => `
                        <label class="flex items-center gap-3 text-gray-300 cursor-pointer requerimiento-item-nuevo">
                            <input type="checkbox"
                                   class="checkbox checkbox-primary checkbox-sm"
                                   value="${r.id}">
                            <span class="requerimiento-nombre-nuevo">${r.nombre}</span>
                        </label>
                    `).join("")}
                </div>
            </div>

            <div class="flex gap-2">
                <button id="guardar-aula" class="btn btn-success btn-sm">‚úì Guardar</button>
                <button onclick="location.reload()" class="btn btn-ghost btn-sm">‚úï Cancelar</button>
            </div>
        </div>
    `;

    // Activar buscador
    const buscadorReqNuevo = document.getElementById('buscador-req-nuevo');
    const itemsReqNuevo = document.querySelectorAll('.requerimiento-item-nuevo');

    buscadorReqNuevo.addEventListener('input', () => {
        const texto = buscadorReqNuevo.value.toLowerCase();
        itemsReqNuevo.forEach(item => {
            const nombre = item.querySelector('.requerimiento-nombre-nuevo').innerText.toLowerCase();
            item.style.display = nombre.includes(texto) ? 'flex' : 'none';
        });
    });

    document.getElementById("guardar-aula").onclick = () => {
        const numero = document.getElementById("nuevo-numero").value;
        const capacidad = document.getElementById("nueva-capacidad").value;

        const seleccionados = Array.from(
            document.querySelectorAll('#lista-req-nuevo input[type="checkbox"]:checked')
        ).map(cb => cb.value);

        const data = new URLSearchParams();
        data.append("numero", numero);
        data.append("capacidad", capacidad);
        seleccionados.forEach(r => data.append("requerimientos[]", r));

        fetch("{% url 'configuracion:crear_aula' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: data.toString()
        }).then(() => cargarAulas());
    };
};

/* =========================
   EDITAR / ELIMINAR
========================= */
function activarEventos() {

    /* ELIMINAR */
    document.querySelectorAll(".btn-eliminar").forEach(btn => {
        btn.onclick = () => {
            if (!confirm("¬øEliminar esta aula?")) return;

            fetch(`/configuracion/aulas/${btn.dataset.id}/eliminar/`, {
                method: "POST",
                headers: { "X-CSRFToken": csrftoken }
            }).then(() => cargarAulas());
        };
    });

    /* EDITAR */
    document.querySelectorAll(".btn-editar").forEach(btn => {
        btn.onclick = () => {

            const id = btn.dataset.id;
            const fila = btn.closest(".flex.items-center.justify-between");
            const contenido = fila.querySelector(".contenido-aula");

            const numero = fila.dataset.numero;
            const capacidad = fila.dataset.capacidad;

            contenido.innerHTML = `
                <div class="flex flex-col gap-3 w-full">
                    <div class="flex gap-2">
                        <input id="edit-numero-${id}"
                               value="${numero}"
                               placeholder="Aula"
                               class="input input-sm bg-[#0f172a] border-white/10 text-white w-20" />

                        <input id="edit-capacidad-${id}"
                               type="number"
                               value="${capacidad}"
                               placeholder="Capacidad"
                               class="input input-sm bg-[#0f172a] border-white/10 text-white w-28" />
                    </div>

                    <div class="w-full">
                        <input type="text"
                               id="buscador-req-${id}"
                               placeholder="Buscar requerimiento..."
                               class="input input-bordered input-sm w-full bg-[#0f172a] border-white/10 text-white mb-2" />

                        <div id="lista-req-${id}"
                             class="max-h-40 overflow-y-auto space-y-2 p-3 rounded-xl bg-[#0f172a] border border-white/10">
                            ${requerimientosGlobales.map(r => `
                                <label class="flex items-center gap-3 text-gray-300 cursor-pointer requerimiento-item-edit">
                                    <input type="checkbox"
                                           class="checkbox checkbox-primary checkbox-sm"
                                           value="${r.id}"
                                           data-req-id="${r.id}">
                                    <span class="requerimiento-nombre-edit">${r.nombre}</span>
                                </label>
                            `).join("")}
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button class="btn btn-success btn-sm" id="guardar-${id}">‚úì Guardar</button>
                        <button class="btn btn-ghost btn-sm" id="cancelar-${id}">‚úï Cancelar</button>
                    </div>
                </div>
            `;

            // Activar buscador de requerimientos
            const buscadorReq = document.getElementById(`buscador-req-${id}`);
            const itemsReq = document.querySelectorAll('.requerimiento-item-edit');

            buscadorReq.addEventListener('input', () => {
                const texto = buscadorReq.value.toLowerCase();
                itemsReq.forEach(item => {
                    const nombre = item.querySelector('.requerimiento-nombre-edit').innerText.toLowerCase();
                    item.style.display = nombre.includes(texto) ? 'flex' : 'none';
                });
            });

            document.getElementById(`guardar-${id}`).onclick = () => {

                const nuevoNumero = document.getElementById(`edit-numero-${id}`).value;
                const nuevaCapacidad = document.getElementById(`edit-capacidad-${id}`).value;

                const seleccionados = Array.from(
                    document.querySelectorAll(`#lista-req-${id} input[type="checkbox"]:checked`)
                ).map(cb => cb.value);

                const data = new URLSearchParams();
                data.append("numero", nuevoNumero);
                data.append("capacidad", nuevaCapacidad);
                seleccionados.forEach(r => data.append("requerimientos[]", r));

                fetch(`/configuracion/aulas/${id}/editar/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrftoken,
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: data.toString()
                }).then(() => cargarAulas());
            };

            document.getElementById(`cancelar-${id}`).onclick = () => cargarAulas();
        };
    });
}

activarEventos();
</script>
{% endblock %}